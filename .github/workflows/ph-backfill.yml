# .github/workflows/ph-backfill.yml
name: PH Backfill
on:
  workflow_dispatch: {}            # still lets you run it by hand
  schedule:
    - cron: "0 */6 * * *"          # runs every 6 hours (UTC)

jobs:
  backfill:
    runs-on: ubuntu-latest
    concurrency: ph-backfill       # prevents overlap
    steps:
      - name: Call sync backfill
        run: |
          URL="${{ secrets.PROD_DOMAIN }}/api/ph/sync?pages=200&size=50&topics=1&delay=1200"
          echo "GET $URL"
          for i in 1 2 3; do
            curl -sS -L --fail-with-body -D - \
              -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
              "$URL" && { echo "âœ… Backfill succeeded"; break; } || { echo "Retry $i"; sleep 10; }
          done
