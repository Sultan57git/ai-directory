name: PH Backfill (posts only)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours UTC

jobs:
  backfill:
    runs-on: ubuntu-latest
    concurrency: ph-backfill
    env:
      BASE: ${{ secrets.PROD_DOMAIN }}/api/ph/sync
      TOKEN: ${{ secrets.CRON_SECRET }}
      TOTAL_PAGES: "2000"   # ~100k rows at size=50
      CHUNK: "40"           # call /sync in chunks so it stays reliable
      SIZE: "50"            # big pages are fine with topics=0
      DELAY: "1000"         # 1s between pages on the server side
    steps:
      - name: Backfill posts in chunks (no topics)
        shell: bash
        run: |
          set -e
          remain=$TOTAL_PAGES
          while [ "$remain" -gt 0 ]; do
            pages=$CHUNK
            [ "$remain" -lt "$CHUNK" ] && pages=$remain
            URL="${BASE}?pages=${pages}&size=${SIZE}&topics=0&delay=${DELAY}"
            echo "GET $URL"
            ok=0
            for i in 1 2 3; do
              out=$(curl -sS -L --fail-with-body -D - -H "Authorization: Bearer $TOKEN" "$URL" || true)
              echo "$out" | tail -n 40
              if echo "$out" | tr -d '\n' | grep -q '"ok":true'; then ok=1; break; fi
              echo "⚠️  Chunk failed (attempt $i). Sleeping 10s…"; sleep 10
            done
            [ $ok -eq 1 ] || { echo "❌ Chunk failed after 3 attempts."; exit 1; }
            remain=$((remain - pages))
          done
          echo "✅ Posts backfill pass completed."
