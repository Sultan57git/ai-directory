name: PH Backfill (tiny)

on:
  workflow_dispatch: {}   # run manually from Actions

jobs:
  backfill:
    runs-on: ubuntu-latest
    concurrency: ph-backfill-tiny
    steps:
      - name: Backfill posts in tiny chunks (safe)
        env:
          PROD_DOMAIN: ${{ secrets.PROD_DOMAIN }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          # SUPER small slice: ~450 posts/run
          PAGES=30          # 30 pages * size 15
          SIZE=15
          DELAY=1800        # 1.8s between pages inside API
          URL="${PROD_DOMAIN}/api/ph/sync?pages=${PAGES}&size=${SIZE}&topics=0&delay=${DELAY}"

          echo "GET $URL"
          for i in 1 2 3; do
            curl -sS -L --fail-with-body -D - \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              "${URL}" && { echo "✅ Tiny backfill succeeded"; exit 0; }
            echo "⚠️ Retry $i"; sleep 12
          done
          echo "❌ Tiny backfill failed after 3 attempts"; exit 1
