name: PH Topics Enrichment (tiny)

on:
  workflow_dispatch: {}   # run manually from Actions

jobs:
  topics:
    runs-on: ubuntu-latest
    concurrency: ph-topics-tiny
    steps:
      - name: Add topics in tiny chunks (safe)
        env:
          PROD_DOMAIN: ${{ secrets.PROD_DOMAIN }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          # Very small slice for topics (heavier queries)
          PAGES=15          # 15 pages * size 15 = 225 posts/run
          SIZE=15
          DELAY=2000        # 2s between pages inside API
          URL="${PROD_DOMAIN}/api/ph/sync?pages=${PAGES}&size=${SIZE}&topics=1&delay=${DELAY}"

          echo "GET $URL"
          for i in 1 2 3; do
            curl -sS -L --fail-with-body -D - \
              -H "Authorization: Bearer ${CRON_SECRET}" \
              "${URL}" && { echo "✅ Tiny topics enrichment succeeded"; exit 0; }
            echo "⚠️ Retry $i"; sleep 12
          done
          echo "❌ Tiny topics enrichment failed after 3 attempts"; exit 1
